<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh sách bài viết</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body class="container mt-4" th:data-base="@{/blogs}">

<div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded shadow-sm">
    <h2 class="m-0 text-primary">Danh sách bài viết</h2>
    <div>
        <a sec:authorize="!isAuthenticated()" th:href="@{/login}" class="btn btn-primary btn-sm">
            <i class="bi bi-box-arrow-in-right"></i> Đăng nhập
        </a>

        <div sec:authorize="isAuthenticated()" class="d-flex align-items-center gap-2">
            <span>Xin chào, <b class="text-success" sec:authentication="name">User</b></span>
            <span sec:authorize="hasRole('ADMIN')" class="badge bg-danger">ADMIN</span>

            <form th:action="@{/logout}" method="post" class="m-0">
                <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-box-arrow-right"></i> Đăng xuất
                </button>
            </form>
        </div>
    </div>
</div>

<div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div class="d-flex justify-content-between mb-3">
    <form th:action="@{/blogs}" method="get" class="d-flex" style="gap:10px; flex-grow: 1; max-width: 600px;">
        <input type="text" name="keyword" th:value="${keyword}" placeholder="Tìm theo tiêu đề..." class="form-control">

        <select name="categoryId" class="form-select w-auto">
            <option value="">-- Tất cả danh mục --</option>
            <option th:each="cat : ${categories}"
                    th:value="${cat.id}"
                    th:text="${cat.name}"
                    th:selected="${cat.id == selectedCategoryId}"></option>
        </select>

        <button type="submit" class="btn btn-primary text-nowrap">
            <i class="bi bi-search"></i> Tìm
        </button>
    </form>

    <div sec:authorize="hasAnyRole('USER', 'ADMIN')">
        <a th:href="@{/blogs/create}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Thêm bài viết
        </a>
    </div>
</div>

<table class="table table-bordered table-striped align-middle shadow-sm">
    <thead class="table-dark text-center">
    <tr>
        <th>STT</th>
        <th>Tiêu đề</th>
        <th>Danh mục</th>
        <th>Tác giả</th>
        <th>Nội dung tóm tắt</th>
        <th>Hành động</th>
    </tr>
    </thead>
    <tbody>
    <tr th:if="${#lists.isEmpty(blogs)}">
        <td colspan="6" class="text-center text-muted">Không có bài viết nào.</td>
    </tr>

    <tr th:each="blog, stat : ${blogs}">
        <td th:text="${stat.count}" class="text-center"></td>
        <td th:text="${blog.title}" class="fw-bold"></td>
        <td th:text="${blog.category != null ? blog.category.name : 'Chưa phân loại'}" class="text-center"></td>
        <td th:text="${blog.author}" class="text-secondary fst-italic"></td>
        <td th:text="${#strings.abbreviate(blog.content, 50)}"></td>
        <td class="text-center" style="min-width: 180px;">
            <a th:href="@{/blogs/{id}(id=${blog.id})}" class="btn btn-sm btn-info text-white" title="Xem chi tiết">
                <i class="bi bi-eye"></i>
            </a>

            <a sec:authorize="hasAnyRole('USER', 'ADMIN')"
               th:href="@{/blogs/edit/{id}(id=${blog.id})}" class="btn btn-sm btn-warning text-white" title="Sửa">
                <i class="bi bi-pencil"></i>
            </a>

            <button sec:authorize="hasRole('ADMIN')"
                    type="button"
                    class="btn btn-sm btn-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteModal"
                    th:attr="data-id=${blog.id}, data-name=${blog.title}" title="Xóa">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
    </tbody>
</table>

<nav th:if="${totalPages > 0}">
    <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
            <a class="page-link" th:href="@{/blogs(page=${currentPage - 1}, keyword=${keyword}, categoryId=${selectedCategoryId})}">Trước</a>
        </li>
        <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
            th:classappend="${i == currentPage} ? 'active'">
            <a class="page-link" th:href="@{/blogs(page=${i}, keyword=${keyword}, categoryId=${selectedCategoryId})}" th:text="${i + 1}"></a>
        </li>
        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
            <a class="page-link" th:href="@{/blogs(page=${currentPage + 1}, keyword=${keyword}, categoryId=${selectedCategoryId})}">Sau</a>
        </li>
    </ul>
</nav>
<div class="text-center mt-3">
    <a href="/home" class="text-decoration-none">⬅ Về Trang Chủ</a>
    <span sec:authorize="hasRole('ADMIN')" class="mx-2">|</span>
    <a sec:authorize="hasRole('ADMIN')" href="/category" class="text-decoration-none fw-bold">Quản lý Danh mục ➡</a>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc muốn xóa bài viết <strong id="blogName"></strong> không?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <a id="confirmDeleteBtn" href="#" class="btn btn-danger">Xóa ngay</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Script xử lý Modal Xóa
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const id = button.getAttribute('data-id');
            const name = button.getAttribute('data-name');
            document.getElementById('blogName').textContent = name;
            const base = document.body.getAttribute('data-base');
            document.getElementById('confirmDeleteBtn').setAttribute('href', base + '/delete/' + id);
        });
    }

    // Tự động tắt thông báo sau 3s
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
</script>
</body>
</html>